<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wiki Whaaaaa?</title>
  <style>
    :root {
      --bg: #ffffff;
      --fg: #444958; /* primary text + highlight */
      --bg-btn: #ececf6;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      background:var(--bg);
      color:var(--fg);
      font-family:'Avenir', 'Helvetica Neue', Helvetica, Arial, sans-serif;
      display:flex;
      flex-direction:column;
      align-items:center;
      min-height:100vh;
      padding:3rem 1rem;
    }
    @keyframes fadeInDown{0%{opacity:0;transform:translateY(-24px);}100%{opacity:1;transform:translateY(0);}}
    @keyframes fadeInUp{0%{opacity:0;transform:translateY(20px);}100%{opacity:1;transform:translateY(0);}}
    h1{
      font-size:3.2rem;
      font-weight:700;
      color:var(--fg);
      letter-spacing:1px;
      text-transform:uppercase;
      opacity:0;
      animation:fadeInDown .6s ease-out forwards;
    }
    #controls{display:flex;flex-direction:column;align-items:center;margin-top:2rem;gap:2.5rem;}
    #categoryButtons{
      display:grid;
      grid-template-columns:repeat(3, auto);
      gap:2rem;
      justify-content:center;
    }
    .btn{
      padding:.7rem 1.4rem;
      font-size:1rem;
      font-weight:600;
      border:none;
      border-radius:12px;
      cursor:pointer;
      background:var(--bg-btn);
      color:var(--fg);
      transition:transform .2s ease,box-shadow .3s ease,background .3s ease;
      box-shadow:0 2px 4px rgba(0,0,0,.06);
      opacity:0; /* will animate in */
      animation:fadeInUp .6s ease-out forwards;
    }
    .btn:hover{transform:translateY(-4px);box-shadow:0 6px 12px rgba(0,0,0,.10);} 
    .btn:active{transform:scale(.95);} 
    .btn.active,.btn.primary{background:var(--fg);color:#fff;}
    #goBtn{background:var(--fg);color:#fff;}
    #result{margin-top:3rem;text-align:center;max-width:40ch;min-height:3rem;}
    #result a{
      display:inline-block;
      color:var(--fg);
      font-size:1.6rem;
      text-decoration:none;
      opacity:0;
      animation:fadeInUp .5s ease-out forwards;
    }
    #errorMsg{color:#c0392b;margin-top:1rem;}
  </style>
</head>
<body>
  <h1>WIKI WHAAAAA?</h1>
  <div id="controls">
    <div id="categoryButtons"></div>
    <button id="goBtn" class="btn primary">LET'S GO</button>
  </div>
  <div id="result"></div>
  <div id="errorMsg"></div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    /* ===== CONFIG ===== */
    const CSV_PATH       = encodeURI('list.csv');
    const TITLE_FIELD    = 'Title';
    const URL_FIELD      = 'URL';
    const CATEGORY_FIELD = 'Category';
    const DONE_FIELD     = 'Completed?';

    // Fallback sample rows for quick offline testing
    const SAMPLE_CSV = `Title,URL,Category,Completed?\nExploding Whale,https://en.wikipedia.org/wiki/Exploding_whale,Animals,\nDancing Plague of 1518,https://en.wikipedia.org/wiki/Dancing_Plague_of_1518,History,\nList of Fictional Ducks,https://en.wikipedia.org/wiki/List_of_fictional_ducks,Lists,`;

    let allRows=[];
    let uncoveredByCat={};
    let currentCategory='Any';

    /* ===== DATA ===== */
    const buildIndex = ()=>{
      const idx={Any:[]};
      allRows.forEach(r=>{
        const cat=r[CATEGORY_FIELD]||'Uncategorised';
        if(!idx[cat]) idx[cat]=[];
        const covered=!!(r[DONE_FIELD]&&String(r[DONE_FIELD]).trim());
        if(!covered){idx[cat].push(r);idx.Any.push(r);} });
      uncoveredByCat=idx;
    };

    /* ===== UI ===== */
    const container=document.getElementById('categoryButtons');
    const resultWrap=document.getElementById('result');

    function populateButtons(){
      container.innerHTML='';
      Object.keys(uncoveredByCat).filter(c=>c!=='Any').sort().forEach((cat,i)=>{
        const btn=document.createElement('button');
        btn.className='btn cat-btn';
        btn.textContent=cat;
        btn.style.animationDelay=`${0.1+i*0.05}s`;
        btn.addEventListener('click',()=>{
          currentCategory=cat;
          document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
        });
        container.appendChild(btn);
      });
    }

    const pick=randomCat=>{
      const arr=uncoveredByCat[randomCat]||[];
      return arr.length?arr[Math.floor(Math.random()*arr.length)]:null;
    };

    function render(row){
      resultWrap.innerHTML='';
      if(!row){resultWrap.textContent='No articles left in this category ðŸ™Œ';return;}
      const a=document.createElement('a');
      a.href=row[URL_FIELD];
      a.target='_blank';a.rel='noopener';
      a.textContent=row[TITLE_FIELD];
      resultWrap.appendChild(a);
      const newURL=new URL(location.href);
      newURL.searchParams.set('row',row.__row);
      history.replaceState({},'',newURL);
    }

    /* ===== LOAD ===== */
    const loadRows=data=>{
      allRows=data.map((r,i)=>({...r,__row:i}));
      buildIndex();
      populateButtons();
    };

    const parseSample=()=>Papa.parse(SAMPLE_CSV,{header:true,skipEmptyLines:true,complete:res=>loadRows(res.data)});

    Papa.parse(CSV_PATH,{header:true,download:true,skipEmptyLines:true,complete:res=>{res.data.length?loadRows(res.data):parseSample();},error:parseSample});

    /* ===== EVENTS ===== */
    document.getElementById('goBtn').addEventListener('click',()=>{
      if(!currentCategory) currentCategory='Any';
      render(pick(currentCategory));
    });
  </script>
</body>
</html>
